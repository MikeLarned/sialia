/* BlueButton.js -- 0.4.3 */

!function(a,b){"object"==typeof exports?module.exports=b():"function"==typeof define&&define.amd?define([],b):a.BlueButton=b()}(this,function(){var a=function(){var b=function(b){if(b=c(b),"<"===b.charAt(0))try{return a.XML.parse(b)}catch(d){console.log&&console.log("File looked like it might be XML but couldn't be parsed.")}try{return JSON.parse(b)}catch(d){throw console.error&&console.error("Error: Cannot parse this file. BB.js only accepts valid XML (for parsing) or JSON (for generation). If you are attempting to provide XML or JSON, please run your data through a validator to see if it is malformed.\n"),d}},c=function(a){return a?a.replace(/^\s+|\s+$/g,""):a},d=function(){var a=function(a){return 10>a?"0"+a:a},b=function(b,c){var d=this[b];return c&&d instanceof Date&&!isNaN(d.getTime())?d._parsedWithTimeData||d.getHours()||d.getMinutes()||d.getSeconds()||d.getMilliseconds()?d.getUTCFullYear()+"-"+a(d.getUTCMonth()+1)+"-"+a(d.getUTCDate())+"T"+a(d.getUTCHours())+":"+a(d.getUTCMinutes())+":"+a(d.getUTCSeconds())+"Z":a(d.getMonth()+1)+"/"+a(d.getDate())+"/"+d.getFullYear():c};return JSON.stringify(this,b,2)},e=function(a){var b;for(var c in a)a.hasOwnProperty(c)&&(b=a[c],null===b&&delete a[c],b instanceof Object&&(b=e(b)));return a};return{parseData:b,stripWhitespace:c,json:d,trim:e}}();a.Codes=function(){var a={F:"female",M:"male",UN:"undifferentiated"},b={N:"annulled",C:"common law",D:"divorced",P:"domestic partner",I:"interlocutory",E:"legally separated",G:"living together",M:"married",O:"other",R:"registered domestic partner",A:"separated",S:"single",U:"unknown",B:"unmarried",T:"unreported",W:"widowed"},c={1001:"adventist",1002:"african religions",1003:"afro-caribbean religions",1004:"agnosticism",1005:"anglican",1006:"animism",1061:"assembly of god",1007:"atheism",1008:"babi & baha'i faiths",1009:"baptist",1010:"bon",1062:"brethren",1011:"cao dai",1012:"celticism",1013:"christian (non-catholic, non-specific)",1063:"christian scientist",1064:"church of christ",1065:"church of god",1014:"confucianism",1066:"congregational",1015:"cyberculture religions",1067:"disciples of christ",1016:"divination",1068:"eastern orthodox",1069:"episcopalian",1070:"evangelical covenant",1017:"fourth way",1018:"free daism",1071:"friends",1072:"full gospel",1019:"gnosis",1020:"hinduism",1021:"humanism",1022:"independent",1023:"islam",1024:"jainism",1025:"jehovah's witnesses",1026:"judaism",1027:"latter day saints",1028:"lutheran",1029:"mahayana",1030:"meditation",1031:"messianic judaism",1073:"methodist",1032:"mitraism",1074:"native american",1075:"nazarene",1033:"new age",1034:"non-roman catholic",1035:"occult",1036:"orthodox",1037:"paganism",1038:"pentecostal",1076:"presbyterian",1039:"process, the",1077:"protestant",1078:"protestant, no denomination",1079:"reformed",1040:"reformed/presbyterian",1041:"roman catholic church",1080:"salvation army",1042:"satanism",1043:"scientology",1044:"shamanism",1045:"shiite (islam)",1046:"shinto",1047:"sikism",1048:"spiritualism",1049:"sunni (islam)",1050:"taoism",1051:"theravada",1081:"unitarian universalist",1052:"unitarian-universalism",1082:"united church of christ",1053:"universal life church",1054:"vajrayana (tibetan)",1055:"veda",1056:"voodoo",1057:"wicca",1058:"yaohushua",1059:"zen buddhism",1060:"zoroastrianism"},d={"2028-9":"asian","2054-5":"black or african american","2135-2":"hispanic or latino","2076-8":"native","2186-5":"not hispanic or latino","2131-1":"other","2106-3":"white"},e={ACC:"accident site",ACHFID:"accreditation location identifier",ACTMIL:"active duty military",ALL:"allergy clinic",AMB:"ambulance",AMPUT:"amputee clinic",ANTIBIOT:"antibiotic",ASSIST:"assistive non-person living subject",AUNT:"aunt",B:"blind",BF:"beef",BILL:"billing contact",BIOTH:"biotherapeutic non-person living subject",BL:"broiler",BMTC:"bone marrow transplant clinic",BMTU:"bone marrow transplant unit",BR:"breeder",BREAST:"breast clinic",BRO:"brother",BROINLAW:"brother-in-law",C:"calibrator",CANC:"child and adolescent neurology clinic",CAPC:"child and adolescent psychiatry clinic",CARD:"ambulatory health care facilities; clinic/center; rehabilitation: cardiac facilities",CAS:"asylum seeker",CASM:"single minor asylum seeker",CATH:"cardiac catheterization lab",CCO:"clinical companion",CCU:"coronary care unit",CHEST:"chest unit",CHILD:"child",CHLDADOPT:"adopted child",CHLDFOST:"foster child",CHLDINLAW:"child in-law",CHR:"chronic care facility",CLAIM:"claimant",CN:"national",CNRP:"non-country member without residence permit",CNRPM:"non-country member minor without residence permit",CO:"companion",COAG:"coagulation clinic",COCBEN:"continuity of coverage beneficiary",COMM:"community location",COMMUNITYLABORATORY:"community laboratory",COUSN:"cousin",CPCA:"permit card applicant",CRIMEVIC:"crime victim",CRP:"non-country member with residence permit",CRPM:"non-country member minor with residence permit",CRS:"colon and rectal surgery clinic",CSC:"community service center",CVDX:"cardiovascular diagnostics or therapeutics unit",DA:"dairy",DADDR:"delivery address",DAU:"natural daughter",DAUADOPT:"adopted daughter",DAUC:"daughter",DAUFOST:"foster daughter",DAUINLAW:"daughter in-law",DC:"therapeutic class",DEBR:"debridement",DERM:"dermatology clinic",DIFFABL:"differently abled",DOMPART:"domestic partner",DPOWATT:"durable power of attorney",DR:"draft",DU:"dual",DX:"diagnostics or therapeutics unit",E:"electronic qc",ECHO:"echocardiography lab",ECON:"emergency contact",ENDO:"endocrinology clinic",ENDOS:"endoscopy lab",ENROLBKR:"enrollment broker",ENT:"otorhinolaryngology clinic",EPIL:"epilepsy unit",ER:"emergency room",ERL:"enrollment",ETU:"emergency trauma unit",EXCEST:"executor of estate",EXT:"extended family member",F:"filler proficiency",FAMDEP:"family dependent",FAMMEMB:"family member",FI:"fiber",FMC:"family medicine clinic",FRND:"unrelated friend",FSTUD:"full-time student",FTH:"father",FTHINLAW:"father-in-law",FULLINS:"fully insured coverage sponsor",G:"group",GACH:"hospitals; general acute care hospital",GD:"generic drug",GDF:"generic drug form",GDS:"generic drug strength",GDSF:"generic drug strength form",GGRFTH:"great grandfather",GGRMTH:"great grandmother",GGRPRN:"great grandparent",GI:"gastroenterology clinic",GIDX:"gastroenterology diagnostics or therapeutics lab",GIM:"general internal medicine clinic",GRFTH:"grandfather",GRMTH:"grandmother",GRNDCHILD:"grandchild",GRNDDAU:"granddaughter",GRNDSON:"grandson",GRPRN:"grandparent",GT:"guarantor",GUADLTM:"guardian ad lidem",GUARD:"guardian",GYN:"gynecology clinic",HAND:"hand clinic",HANDIC:"handicapped dependent",HBRO:"half-brother",HD:"hemodialysis unit",HEM:"hematology clinic",HLAB:"hospital laboratory",HOMEHEALTH:"home health",HOSP:"hospital",HPOWATT:"healthcare power of attorney",HRAD:"radiology unit",HSIB:"half-sibling",HSIS:"half-sister",HTN:"hypertension clinic",HU:"hospital unit",HUSB:"husband",HUSCS:"specimen collection site",ICU:"intensive care unit",IEC:"impairment evaluation center",INDIG:"member of an indigenous people",INFD:"infectious disease clinic",INJ:"injured plaintiff",INJWKR:"injured worker",INLAB:"inpatient laboratory",INPHARM:"inpatient pharmacy",INV:"infertility clinic",JURID:"jurisdiction location identifier",L:"pool",LABORATORY:"laboratory",LOCHFID:"local location identifier",LY:"layer",LYMPH:"lympedema clinic",MAUNT:"maternalaunt",MBL:"medical laboratory",MCOUSN:"maternalcousin",MGDSF:"manufactured drug strength form",MGEN:"medical genetics clinic",MGGRFTH:"maternalgreatgrandfather",MGGRMTH:"maternalgreatgrandmother",MGGRPRN:"maternalgreatgrandparent",MGRFTH:"maternalgrandfather",MGRMTH:"maternalgrandmother",MGRPRN:"maternalgrandparent",MHSP:"military hospital",MIL:"military",MOBL:"mobile unit",MT:"meat",MTH:"mother",MTHINLAW:"mother-in-law",MU:"multiplier",MUNCLE:"maternaluncle",NBOR:"neighbor",NBRO:"natural brother",NCCF:"nursing or custodial care facility",NCCS:"neurology critical care and stroke unit",NCHILD:"natural child",NEPH:"nephrology clinic",NEPHEW:"nephew",NEUR:"neurology clinic",NFTH:"natural father",NFTHF:"natural father of fetus",NIECE:"niece",NIENEPH:"niece/nephew",NMTH:"natural mother",NOK:"next of kin",NPRN:"natural parent",NS:"neurosurgery unit",NSIB:"natural sibling",NSIS:"natural sister",O:"operator proficiency",OB:"obstetrics clinic",OF:"outpatient facility",OMS:"oral and maxillofacial surgery clinic",ONCL:"medical oncology clinic",OPH:"opthalmology clinic",OPTC:"optometry clinic",ORG:"organizational contact",ORTHO:"orthopedics clinic",OUTLAB:"outpatient laboratory",OUTPHARM:"outpatient pharmacy",P:"patient",PAINCL:"pain clinic",PATHOLOGIST:"pathologist",PAUNT:"paternalaunt",PAYOR:"payor contact",PC:"primary care clinic",PCOUSN:"paternalcousin",PEDC:"pediatrics clinic",PEDCARD:"pediatric cardiology clinic",PEDE:"pediatric endocrinology clinic",PEDGI:"pediatric gastroenterology clinic",PEDHEM:"pediatric hematology clinic",PEDHO:"pediatric oncology clinic",PEDICU:"pediatric intensive care unit",PEDID:"pediatric infectious disease clinic",PEDNEPH:"pediatric nephrology clinic",PEDNICU:"pediatric neonatal intensive care unit",PEDRHEUM:"pediatric rheumatology clinic",PEDU:"pediatric unit",PGGRFTH:"paternalgreatgrandfather",PGGRMTH:"paternalgreatgrandmother",PGGRPRN:"paternalgreatgrandparent",PGRFTH:"paternalgrandfather",PGRMTH:"paternalgrandmother",PGRPRN:"paternalgrandparent",PH:"policy holder",PHARM:"pharmacy",PHLEBOTOMIST:"phlebotomist",PHU:"psychiatric hospital unit",PL:"pleasure",PLS:"plastic surgery clinic",POD:"podiatry clinic",POWATT:"power of attorney",PRC:"pain rehabilitation center",PREV:"preventive medicine clinic",PRN:"parent",PRNINLAW:"parent in-law",PROCTO:"proctology clinic",PROFF:"provider's office",PROG:"program eligible",PROS:"prosthodontics clinic",PSI:"psychology clinic",PSTUD:"part-time student",PSY:"psychiatry clinic",PSYCHF:"psychiatric care facility",PT:"patient",PTRES:"patient's residence",PUNCLE:"paternaluncle",Q:"quality control",R:"replicate",RADDX:"radiology diagnostics or therapeutics unit",RADO:"radiation oncology unit",RC:"racing",RESPRSN:"responsible party",RETIREE:"retiree",RETMIL:"retired military",RH:"rehabilitation hospital",RHAT:"addiction treatment center",RHEUM:"rheumatology clinic",RHII:"intellectual impairment center",RHMAD:"parents with adjustment difficulties center",RHPI:"physical impairment center",RHPIH:"physical impairment - hearing center",RHPIMS:"physical impairment - motor skills center",RHPIVS:"physical impairment - visual skills center",RHU:"rehabilitation hospital unit",RHYAD:"youths with adjustment difficulties center",RNEU:"neuroradiology unit",ROOM:"roommate",RTF:"residential treatment facility",SCHOOL:"school",SCN:"screening",SEE:"seeing",SELF:"self",SELFINS:"self insured coverage sponsor",SH:"show",SIB:"sibling",SIBINLAW:"sibling in-law",SIGOTHR:"significant other",SIS:"sister",SISINLAW:"sister-in-law",SLEEP:"sleep disorders unit",SNF:"skilled nursing facility",SNIFF:"sniffing",SON:"natural son",SONADOPT:"adopted son",SONC:"son",SONFOST:"foster son",SONINLAW:"son in-law",SPMED:"sports medicine clinic",SPON:"sponsored dependent",SPOWATT:"special power of attorney",SPS:"spouse",STPBRO:"stepbrother",STPCHLD:"step child",STPDAU:"stepdaughter",STPFTH:"stepfather",STPMTH:"stepmother",STPPRN:"step parent",STPSIB:"step sibling",STPSIS:"stepsister",STPSON:"stepson",STUD:"student",SU:"surgery clinic",SUBJECT:"self",SURF:"substance use rehabilitation facility",THIRDPARTY:"third party",TPA:"third party administrator",TR:"transplant clinic",TRAVEL:"travel and geographic medicine clinic",TRB:"tribal member",UMO:"utilization management organization",UNCLE:"uncle",UPC:"underage protection center",URO:"urology clinic",V:"verifying",VET:"veteran",VL:"veal",WARD:"ward",WIFE:"wife",WL:"wool",WND:"wound clinic",WO:"working",WORK:"work site"},f={55561003:"active",73425007:"inactive",413322009:"resolved"},g=function(a){for(var b={},c=Object.keys(a),d=0,e=c.length;e>d;d++)b[a[c[d]]]=c[d];return b},h=function(a){return function(b){return a[b]||null}},i=function(a){return function(b){if(!b)return null;var c=g(a);return b=b.toLowerCase(),c[b]||null}};return{gender:h(a),reverseGender:i(a),maritalStatus:h(b),reverseMaritalStatus:i(b),religion:h(c),reverseReligion:i(c),raceEthnicity:h(d),reverseRaceEthnicity:i(d),role:h(e),reverseRole:i(e),problemStatus:h(f),reverseProblemStatus:i(f)}}(),a.XML=function(){var b,c=function(a){function b(a){return{el:a,template:e,content:f,tag:g,immediateChildTag:h,elsByTag:i,attr:k,boolAttr:l,val:m,isEmpty:o}}if(a.length){for(var c=[],d=0;d<a.length;d++)c.push(b(a[d]));return c}return b(a)},d=function(a,b,c,d){a=a.getElementsByTagName(b);for(var e=0;e<a.length;e++)if(a[e].getAttribute(c)===d)return a[e]},e=function(a){var b=d(this.el,"templateId","root",a);return b?c(b.parentNode):n()},f=function(a){var b=d(this.el,"content","ID",a);return b||(b=d(this.el,"td","ID",a)),b||(b=d(this.el,"caption","ID",a)||d(this.el,"paragraph","ID",a)||d(this.el,"tr","ID",a)||d(this.el,"item","ID",a)),b?c(b):n()},g=function(a){var b=this.el.getElementsByTagName(a)[0];return b?c(b):n()},h=function(a){var b=this.el.getElementsByTagName(a);if(!b)return null;for(var d=0;d<b.length;d++)if(b[d].parentNode===this.el)return c(b[d]);return n()},i=function(a){return c(this.el.getElementsByTagName(a))},j=function(a){return a?a.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&apos;/g,"'"):a},k=function(a){if(!this.el)return null;var b=this.el.getAttribute(a);return b?j(b):null},l=function(a){var b=this.attr(a);return"true"===b||"1"===b},m=function(b){if(!this.el)return null;if(!this.el.childNodes||!this.el.childNodes.length)return null;var d=b?this.el.innerHTML:this.el.textContent;if(!a.stripWhitespace(d)){var e;if(1===this.el.childNodes.length&&"reference"===this.el.childNodes[0].tagName)e=this.el.childNodes[0].getAttribute("value");else{if(3!==this.el.childNodes.length||"reference"!==this.el.childNodes[1].tagName)return j(d);e=this.el.childNodes[1].getAttribute("value")}if(e&&"#"===e[0]){e=e.slice(1);var f=c(this.el.ownerDocument),g=f.content(e);return g.val()}}return j(d)},n=function(){var a=s.createElement("empty");return c(a)},o=function(){return"empty"===this.el.tagName.toLowerCase()},p=function(a){if(!a||"string"!=typeof a)return console.log("BB Error: XML data is not a string"),null;var d,e;if(r)e=new b.DOMParser,d=e.parseFromString(a,"text/xml");else if(window.DOMParser)e=new DOMParser,d=e.parseFromString(a,"text/xml");else try{d=new ActiveXObject("Microsoft.XMLDOM"),d.async="false",d.loadXML(a)}catch(f){console.log("BB ActiveX Exception: Could not parse XML")}return d&&d.documentElement&&!d.getElementsByTagName("parsererror").length?c(d):(console.log("BB Error: Could not parse XML"),null)},q=this,r=!1,s=q.document;return"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(r=!0,b=require("xmldom"),s=(new b.DOMImplementation).createDocument()),{parse:p}}();var b=function(){function a(a){a=a||"";var c=a.match(g)||[],d=c[c.length-1]||[],e=(d+"").match(f)||["-",0,0],h=+(60*e[1])+b(e[2]);return"+"===e[0]?h:-h}function b(a){var b=+a,c=0;return 0!==b&&isFinite(b)&&(c=b>=0?Math.floor(b):Math.ceil(b)),c}var c=function(a){return a.template?a.template("2.16.840.1.113883.3.88.11.32.1").isEmpty()?a.template("2.16.840.1.113883.10.20.22.1.1").isEmpty()?a.template("2.16.840.1.113883.10.20.22.1.15").isEmpty()?void 0:"ccdar2":"ccda":"c32":"json"},d=function(){var a=function(a){for(var b=0;b<this.length;b++)a(this[b])},b=this.elsByTag("entry");return b.each=a,b},e=function(c){if(!c||"string"!=typeof c)return null;if(4===c.length)return new Date(c,0,1);var d=c.substr(0,4),e=parseInt(c.substr(4,2),10)-1,f=c.substr(6,2)||1;if(c.length>=12){var g=c.substr(8,2),h=c.substr(10,2),i=c.substr(12,2);if(c.length>14){var j=a(c.substr(14));h=b(h)-j}var k=new Date(Date.UTC(d,e,f,g,h,i));return k._parsedWithTimeData=!0,k}return new Date(d,e,f)},f=/([\+\-]|\d\d)/gi,g=/Z|[\+\-]\d\d:?\d\d/gi,h=function(a){for(var b=a.tag("prefix").val(),c=a.elsByTag("given"),d=[],e=0;e<c.length;e++){var f=c[e].val();f&&d.push(f)}var g=a.tag("family").val();return{prefix:b,given:d,family:g}},i=function(a){for(var b=a.elsByTag("streetAddressLine"),c=[],d=0;d<b.length;d++){var e=b[d].val();e&&c.push(e)}var f=a.tag("city").val(),g=a.tag("state").val(),h=a.tag("postalCode").val(),i=a.tag("country").val();return{street:c,city:f,state:g,zip:h,country:i}};return"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(module.exports={parseDate:e}),{detect:c,entries:d,parseDate:e,parseName:h,parseAddress:i}}();b.C32=function(){var a=function(a){return a.section=c,a},c=function(a){var c,d=b.entries;switch(a){case"document":return this.template("2.16.840.1.113883.3.88.11.32.1");case"allergies":return c=this.template("2.16.840.1.113883.3.88.11.83.102"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.1.2")),c.entries=d,c;case"demographics":return this.template("2.16.840.1.113883.3.88.11.32.1");case"encounters":return c=this.template("2.16.840.1.113883.3.88.11.83.127"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.1.3")),c.entries=d,c;case"immunizations":return c=this.template("2.16.840.1.113883.3.88.11.83.117"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.1.6")),c.entries=d,c;case"results":return c=this.template("2.16.840.1.113883.3.88.11.83.122"),c.entries=d,c;case"medications":return c=this.template("2.16.840.1.113883.3.88.11.83.112"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.1.8")),c.entries=d,c;case"problems":return c=this.template("2.16.840.1.113883.3.88.11.83.103"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.1.11")),c.entries=d,c;case"procedures":return c=this.template("2.16.840.1.113883.3.88.11.83.108"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.1.12")),c.entries=d,c;case"vitals":return c=this.template("2.16.840.1.113883.3.88.11.83.119"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.1.16")),c.entries=d,c}return null};return{process:a,section:c}}(),b.CCDA=function(){var a=function(a){return a.section=c,a},c=function(a){var c,d=b.entries;switch(a){case"document":return this.template("2.16.840.1.113883.10.20.22.1.1");case"allergies":return c=this.template("2.16.840.1.113883.10.20.22.2.6.1"),c.entries=d,c;case"care_plan":return c=this.template("2.16.840.1.113883.10.20.22.2.10"),c.entries=d,c;case"chief_complaint":return c=this.template("2.16.840.1.113883.10.20.22.2.13"),c.isEmpty()&&(c=this.template("1.3.6.1.4.1.19376.1.5.3.1.1.13.2.1")),c;case"demographics":return this.template("2.16.840.1.113883.10.20.22.1.1");case"encounters":return c=this.template("2.16.840.1.113883.10.20.22.2.22"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.22.2.22.1")),c.entries=d,c;case"functional_statuses":return c=this.template("2.16.840.1.113883.10.20.22.2.14"),c.entries=d,c;case"immunizations":return c=this.template("2.16.840.1.113883.10.20.22.2.2.1"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.22.2.2")),c.entries=d,c;case"instructions":return c=this.template("2.16.840.1.113883.10.20.22.2.45"),c.entries=d,c;case"results":return c=this.template("2.16.840.1.113883.10.20.22.2.3.1"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.22.2.3")),c.entries=d,c;case"medications":return c=this.template("2.16.840.1.113883.10.20.22.2.1.1"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.22.2.1")),c.entries=d,c;case"problems":return c=this.template("2.16.840.1.113883.10.20.22.2.5.1"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.22.2.5")),c.entries=d,c;case"procedures":return c=this.template("2.16.840.1.113883.10.20.22.2.7.1"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.22.2.7")),c.entries=d,c;case"social_history":return c=this.template("2.16.840.1.113883.10.20.22.2.17"),c.entries=d,c;case"vitals":return c=this.template("2.16.840.1.113883.10.20.22.2.4.1"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.22.2.4")),c.entries=d,c}return null};return{process:a,section:c}}(),b.CCDAR2=function(){var a=function(a){return a.section=c,a},c=function(a){var c,d=b.entries;switch(a){case"document":return this.template("2.16.840.1.113883.10.20.22.1.15");case"demographics":return this.template("2.16.840.1.113883.10.20.22.1.15");case"health_concerns_document":return c=this.template("2.16.840.1.113883.10.20.22.2.58"),c.entries=d,c;case"goals":return c=this.template("2.16.840.1.113883.10.20.22.2.60"),c.entries=d,c;case"interventions":return c=this.template("2.16.840.1.113883.10.20.21.2.3"),c.entries=d,c;case"health_status_outcomes":return c=this.template("2.16.840.1.113883.10.20.22.2.61"),c.entries=d,c}return null};return{process:a,section:c}}();var c=function(){var a=function(){};if("undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(ejs=require("ejs")),"undefined"!=typeof ejs){var b=function(a){return 10>a?"0"+a:String(a)};ejs.filters.hl7Date=function(a){try{if(null===a||void 0===a)return'nullFlavor="UNK"';var c=new Date(a);if(isNaN(c.getTime()))return a;var d=null;if(c.getHours()||c.getMinutes()||c.getSeconds()){d=c.getUTCFullYear()+b(c.getUTCMonth()+1)+b(c.getUTCDate());var e=b(c.getUTCHours())+b(c.getUTCMinutes())+b(c.getUTCSeconds())+"+0000";return'value="'+d+e+'"'}return d=String(c.getFullYear())+b(c.getMonth()+1)+b(c.getDate()),'value="'+d+'"'}catch(f){return a}};var c=function(a){return a.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")};ejs.filters.hl7Code=function(a){if(!a)return"";var b="",d=a.name||"";return a.name&&(b+='displayName="'+c(d)+'"'),a.code?(b+=' code="'+a.code+'"',a.code_system&&(b+=' codeSystem="'+c(a.code_system)+'"'),a.code_system_name&&(b+=' codeSystemName="'+c(a.code_system_name)+'"')):b+=' nullFlavor="UNK"',a.name||a.code?b:'nullFlavor="UNK"'},ejs.filters.emptyStringIfFalsy=function(a){return a?a:""},ejs.helpers||(ejs.helpers={}),ejs.helpers.simpleTag=function(a,b){return b?"<"+a+">"+b+"</"+a+">":"<"+a+' nullFlavor="UNK" />'},ejs.helpers.addressTags=function(a){if(!a)return'<streetAddressLine nullFlavor="NI" />\n<city nullFlavor="NI" />\n<state nullFlavor="NI" />\n<postalCode nullFlavor="NI" />\n<country nullFlavor="NI" />\n';var b="";if(a.street.length)for(var c=0;c<a.street.length;c++)b+=ejs.helpers.simpleTag("streetAddressLine",a.street[c])+"\n";else b+=ejs.helpers.simpleTag("streetAddressLine",null)+"\n";return b+=ejs.helpers.simpleTag("city",a.city)+"\n",b+=ejs.helpers.simpleTag("state",a.state)+"\n",b+=ejs.helpers.simpleTag("postalCode",a.zip)+"\n",b+=ejs.helpers.simpleTag("country",a.country)+"\n"},ejs.helpers.nameTags=function(a){if(!a)return'<given nullFlavor="NI" />\n<family nullFlavor="NI" />\n';var b="";if(a.prefix&&(b+=ejs.helpers.simpleTag("prefix",a.prefix)+"\n"),a.given.length)for(var c=0;c<a.given.length;c++)b+=ejs.helpers.simpleTag("given",a.given[c])+"\n";else b+=ejs.helpers.simpleTag("given",null)+"\n";return b+=ejs.helpers.simpleTag("family",a.family)+"\n",a.suffix&&(b+=ejs.helpers.simpleTag("suffix",a.suffix)+"\n"),b}}return{method:a}}();c.C32=function(){var a=function(a,b,c){return console.log("C32 generation is not implemented yet"),null};return{run:a}}(),c.CCDA=function(){var b=function(b,c,d){if(!ejs)return console.log("The BB.js Generator (JSON->XML) requires the EJS template package. Install it in Node or include it before this package in the browser."),null;if(!c)return console.log("Please provide a template EJS file for the Generator to use. Load it via fs.readFileSync in Node or XHR in the browser."),null;var e=d?new Date("2000-01-01T12:00:00Z"):new Date,f=ejs.render(c,{filename:"ccda.xml",bb:b,now:e,tagHelpers:ejs.helpers,codes:a.Codes});return f};return{run:b}}();var d=function(){var a=function(){};return{method:a}}();d.C32=function(){var b=function(b){var c={};return c.document=d.C32.document(b),c.allergies=d.C32.allergies(b),c.demographics=d.C32.demographics(b),c.encounters=d.C32.encounters(b),c.immunizations=d.C32.immunizations(b).administered,c.immunization_declines=d.C32.immunizations(b).declined,c.results=d.C32.results(b),c.medications=d.C32.medications(b),c.problems=d.C32.problems(b),c.procedures=d.C32.procedures(b),c.vitals=d.C32.vitals(b),c.json=a.json,c.document.json=a.json,c.allergies.json=a.json,c.demographics.json=a.json,c.encounters.json=a.json,c.immunizations.json=a.json,c.immunization_declines.json=a.json,c.results.json=a.json,c.medications.json=a.json,c.problems.json=a.json,c.procedures.json=a.json,c.vitals.json=a.json,c.smoking_status={date:null,name:null,code:null,code_system:null,code_system_name:null},c.smoking_status.json=a.json,c.chief_complaint={text:null},c.chief_complaint.json=a.json,c.care_plan=[],c.care_plan.json=a.json,c.instructions=[],c.instructions.json=a.json,c.functional_statuses=[],c.functional_statuses.json=a.json,d.GenericInfo(b,c),c};return{run:b}}(),d.C32.document=function(c){var d,e,f=b.parseDate,g=b.parseName,h=b.parseAddress,i={},j=c.section("document"),k=j.elsByTag("templateId"),l=k[0].attr("root");e=k.length>1?k[1].attr("root"):l;var m=j.tag("code").attr("code"),n=(j.tag("templateId").attr("root"),j.tag("code").attr("displayName")),o=j.tag("nonXMLBody"),p=o.el.childNodes,q="structured",r={type:"",mediaType:"",representation:"",rawText:"",reference:""};if(p&&p.length>0){q="unstructured";var s=o.tag("text"),t="",u="",v="",w="",x="";s&&s.attr("mediaType")&&(t=s.attr("mediaType"),u=s.attr("representation"),v=s.val(),x="embedded"),s&&!t&&(w=s.tag("reference").attr("value"),x="reference"),r={type:x,mediaType:t,representation:u,rawText:v,reference:w}}var y={type:"CCDAR2",rootTemplateId:l,templateId:e,displayName:n,loinc:m,bodyType:q,nonXmlBody:r};console.log("DOCTYPE"),console.log(y);var z=f(j.tag("effectiveTime").attr("value")),A=a.stripWhitespace(j.tag("title").val()),B=j.tag("author");d=B.tag("assignedPerson").tag("name");var C=g(d);C.prefix||C.given.length||C.family||(C.family=d.val()),d=B.tag("addr");var D=h(d);d=B.tag("telecom");for(var E=d.attr("value"),F=[],G=j.tag("documentationOf").elsByTag("performer"),H=0;H<G.length;H++){d=G[H].tag("assignedPerson").tag("name");var I=g(d),J=G[H].tag("telecom").attr("value"),K=h(d.tag("addr"));F.push({name:I,phone:{work:J},address:K})}d=j.tag("encompassingEncounter");var L=a.stripWhitespace(d.tag("name").val()),M=h(d.tag("addr")),N=null;return d=d.tag("effectiveTime"),d.isEmpty()||(N=f(d.attr("value"))),i={type:y,date:z,title:A,author:{name:C,address:D,phone:{work:E}},documentation_of:F,location:{name:L,address:M,encounter_date:N}}},d.C32.allergies=function(c){var d,e=b.parseDate,f=(b.parseName,b.parseAddress,c.section("allergies")),g={};return g.entries=[],g.displayName="Allergies",g.templateId="",g.text=f.tag("text").val(),f.entries().each(function(b){d=b.tag("effectiveTime");var c=e(d.tag("low").attr("value")),f=e(d.tag("high").attr("value"));d=b.template("2.16.840.1.113883.3.88.11.83.6").tag("code");var h=d.attr("displayName"),i=d.attr("code"),j=d.attr("codeSystem"),k=d.attr("codeSystemName");d=b.template("2.16.840.1.113883.3.88.11.83.6").tag("value");var l=d.attr("displayName"),m=d.attr("code"),n=d.attr("codeSystem"),o=d.attr("codeSystemName");d=b.template("2.16.840.1.113883.10.20.1.54").tag("value");var p=d.attr("displayName"),q=d.attr("code"),r=d.attr("codeSystem");p||(d=b.template("2.16.840.1.113883.10.20.1.54").tag("text"),d.isEmpty()||(p=a.stripWhitespace(d.val()))),d=b.template("2.16.840.1.113883.10.20.1.55").tag("value");var s=d.attr("displayName");d=b.tag("participant").tag("code");var t=d.attr("displayName"),u=d.attr("code"),v=d.attr("codeSystem"),w=d.attr("codeSystemName");t||(d=b.tag("participant").tag("name"),d.isEmpty()||(t=d.val())),t||(d=b.template("2.16.840.1.113883.3.88.11.83.6").tag("originalText"),d.isEmpty()||(t=a.stripWhitespace(d.val()))),d=b.template("2.16.840.1.113883.10.20.1.39").tag("value");var x=d.attr("displayName");g.entries.push({date_range:{start:c,end:f},name:h,code:i,code_system:j,code_system_name:k,status:x,severity:s,reaction:{name:p,code:q,code_system:r},reaction_type:{name:l,code:m,code_system:n,code_system_name:o},allergen:{name:t,code:u,code_system:v,code_system_name:w}})}),g},d.C32.demographics=function(c){var d,e=b.parseDate,f=b.parseName,g=b.parseAddress,h={},i=c.section("demographics"),j=i.tag("patientRole");d=j.tag("patient").tag("name");var k=f(d);d=j.tag("patient");var l=e(d.tag("birthTime").attr("value")),m=a.Codes.gender(d.tag("administrativeGenderCode").attr("code")),n=a.Codes.maritalStatus(d.tag("maritalStatusCode").attr("code"));d=j.tag("addr");var o=g(d);d=j.tag("telecom");var p=d.attr("value"),q=null,r=null,s=null,t=j.tag("languageCommunication").tag("languageCode").attr("code"),u=j.tag("raceCode").attr("displayName"),v=j.tag("ethnicGroupCode").attr("displayName"),w=j.tag("religiousAffiliationCode").attr("displayName");d=j.tag("birthplace");var x=g(d);d=j.tag("guardian");var y=d.tag("code").attr("displayName"),z=d.tag("code").attr("code"),A=d.tag("telecom").attr("value");d=d.tag("guardianPerson").tag("name");var B=f(d);d=j.tag("guardian").tag("addr");var C=g(d);d=j.tag("providerOrganization");var D=d.tag("name").val(),E=d.tag("telecom").attr("value"),F=g(d.tag("addr"));return h={name:k,dob:l,gender:m,marital_status:n,address:o,phone:{home:p,work:q,mobile:r},email:s,language:t,race:u,ethnicity:v,religion:w,birthplace:{state:x.state,zip:x.zip,country:x.country},guardian:{name:{given:B.given,family:B.family},relationship:y,relationship_code:z,address:C,phone:{home:A}},provider:{organization:D,phone:E,address:F}}},d.C32.encounters=function(a){var c,d=b.parseDate,e=(b.parseName,b.parseAddress),f=a.section("encounters"),g={};return g.entries=[],g.displayName="Encounters",g.templateId="",g.text=f.tag("text").val(),f.entries().each(function(a){var b=d(a.tag("effectiveTime").attr("value"));b||(b=d(a.tag("effectiveTime").tag("low").attr("value"))),c=a.tag("code");var f=c.attr("displayName"),h=c.attr("code"),i=c.attr("codeSystem"),j=c.attr("codeSystemName"),k=c.attr("codeSystemVersion");c=a.tag("translation");var l=c.attr("displayName"),m=c.attr("code"),n=c.attr("codeSystem"),o=c.attr("codeSystemName");c=a.tag("performer");var p=c.tag("name").val(),q=c.attr("code"),r=c.attr("codeSystem"),s=c.attr("codeSystemName");c=a.tag("participant");var t=c.tag("name").val(),u=e(c);u.organization=t;for(var v=[],w=a.elsByTag("entryRelationship"),x=0;x<w.length;x++)c=w[x].tag("value"),v.push({name:c.attr("displayName"),code:c.attr("code"),code_system:c.attr("codeSystem")});g.entries.push({date:b,name:f,code:h,code_system:i,code_system_name:j,code_system_version:k,findings:v,translation:{name:l,code:m,code_system:n,code_system_name:o},performer:{name:p,code:q,code_system:r,code_system_name:s},location:u})}),g},d.C32.immunizations=function(c){var d,e,f=b.parseDate,g=(b.parseName,b.parseAddress,{}),h={},i=c.section("immunizations");return g.entries=[],g.displayName="Immunizations",g.templateId="",g.text=i.tag("text").val(),h.entries=[],h.displayName="Immunizations Declined",h.templateId="",h.text=i.tag("text").val(),i.entries().each(function(b){e=b.tag("effectiveTime");var c=f(e.attr("value"));c||(c=f(e.tag("low").attr("value"))),e=b.tag("substanceAdministration");var i=e.boolAttr("negationInd");d=b.template("2.16.840.1.113883.10.20.1.53"),e=d.tag("code");var j=e.attr("displayName"),k=e.attr("code"),l=e.attr("codeSystem"),m=e.attr("codeSystemName");e=d.tag("translation");var n=e.attr("displayName"),o=e.attr("code"),p=e.attr("codeSystem"),q=e.attr("codeSystemName");e=d.tag("lotNumberText");var r=e.val();e=d.tag("manufacturerOrganization");var s=e.tag("name").val();e=b.tag("routeCode");var t=e.attr("displayName"),u=e.attr("code"),v=e.attr("codeSystem"),w=e.attr("codeSystemName");e=b.template("2.16.840.1.113883.10.20.1.49");var x=a.stripWhitespace(e.tag("text").val());e=e.tag("code");var y=e.attr("displayName"),z=e.attr("code"),A=e.attr("codeSystem");e=b.tag("doseQuantity");var B=e.attr("value"),C=e.attr("unit"),D=i?h:g;D.entries.push({date:c,product:{name:j,code:k,code_system:l,code_system_name:m,
translation:{name:n,code:o,code_system:p,code_system_name:q},lot_number:r,manufacturer_name:s},dose_quantity:{value:B,unit:C},route:{name:t,code:u,code_system:v,code_system_name:w},instructions:x,education_type:{name:y,code:z,code_system:A}})}),{administered:g,declined:h}},d.C32.results=function(c){var d,e=b.parseDate,f=(b.parseName,b.parseAddress,c.section("results")),g={};return g.entries=[],g.displayName="Results",g.templateId="",g.text=f.tag("text").val(),f.entries().each(function(b){d=b.tag("effectiveTime");var c=e(b.tag("effectiveTime").attr("value"));c||(c=e(b.tag("effectiveTime").tag("low").attr("value"))),d=b.tag("code");for(var f,h=d.attr("displayName"),i=d.attr("code"),j=d.attr("codeSystem"),k=d.attr("codeSystemName"),l=b.elsByTag("observation"),m=[],n=0;n<l.length;n++)if(f=l[n],f.template("2.16.840.1.113883.10.20.1.31").val()){var o=e(f.tag("effectiveTime").attr("value"));d=f.tag("code");var p=d.attr("displayName"),q=d.attr("code"),r=d.attr("codeSystem"),s=d.attr("codeSystemName");p||(p=a.stripWhitespace(f.tag("text").val())),d=f.tag("translation");var t=d.attr("displayName"),u=d.attr("code"),v=d.attr("codeSystem"),w=d.attr("codeSystemName");d=f.tag("value");var x=d.attr("value"),y=d.attr("unit");x&&!isNaN(parseFloat(x))&&(x=parseFloat(x)),x||(x=d.val()),d=f.tag("referenceRange");var z=a.stripWhitespace(d.tag("observationRange").tag("text").val()),A=d.tag("observationRange").tag("low").attr("unit"),B=d.tag("observationRange").tag("low").attr("value"),C=d.tag("observationRange").tag("high").attr("unit"),D=d.tag("observationRange").tag("high").attr("value");m.push({date:o,name:p,value:x,unit:y,code:q,code_system:r,code_system_name:s,translation:{name:t,code:u,code_system:v,code_system_name:w},reference_range:{text:z,low_unit:A,low_value:B,high_unit:C,high_value:D}})}g.entries.push({name:h,code:i,code_system:j,code_system_name:k,date:c,tests:m})}),g},d.C32.medications=function(c){var d,e=b.parseDate,f=c.section("medications"),g={};return g.entries=[],g.displayName="Medications",g.templateId="",g.text=f.tag("text").val(),f.entries().each(function(b){var c=null;d=b.tag("substanceAdministration").immediateChildTag("text"),d.isEmpty()||(c=a.stripWhitespace(d.val()));var f=b.elsByTag("effectiveTime");d=f[0];var h=null,i=null;d&&(h=e(d.tag("low").attr("value")),i=e(d.tag("high").attr("value"))),d=f[1];var j=null,k=null,l=null;if(d&&"PIVL_TS"===d.attr("xsi:type")){var m=d.attr("institutionSpecified");"true"===m?j="frequency":"false"===m&&(j="interval"),d=d.tag("period"),k=d.attr("value"),l=d.attr("unit")}d=b.tag("manufacturedProduct").tag("code");var n=d.attr("displayName"),o=d.attr("code"),p=d.attr("codeSystem"),q=null;d=b.tag("manufacturedProduct").tag("originalText"),d.isEmpty()||(q=a.stripWhitespace(d.val())),!n&&q&&(n=q),n||(d=b.tag("manufacturedProduct").tag("name"),d.isEmpty()||(n=a.stripWhitespace(d.val()))),d=b.tag("manufacturedProduct").tag("translation");var r=d.attr("displayName"),s=d.attr("code"),t=d.attr("codeSystem"),u=d.attr("codeSystemName");d=b.tag("doseQuantity");var v=d.attr("value"),w=d.attr("unit");d=b.tag("rateQuantity");var x=d.attr("value"),y=d.attr("unit");d=b.tag("precondition").tag("value");var z=d.attr("displayName"),A=d.attr("code"),B=d.attr("codeSystem");d=b.template("2.16.840.1.113883.10.20.1.28").tag("value");var C=d.attr("displayName"),D=d.attr("code"),E=d.attr("codeSystem");d=b.tag("routeCode");var F=d.attr("displayName"),G=d.attr("code"),H=d.attr("codeSystem"),I=d.attr("codeSystemName");d=b.tag("participant").tag("playingEntity");var J=d.tag("name").val();d=d.tag("code"),J=d.attr("displayName")||J;var K=d.attr("code"),L=d.attr("codeSystem"),M=d.attr("codeSystemName");d=b.tag("administrationUnitCode");var N=d.attr("displayName"),O=d.attr("code"),P=d.attr("codeSystem"),Q=d.attr("codeSystemName");d=b.tag("performer");var R=d.tag("name").val(),S=null;g.entries.push({date_range:{start:h,end:i},text:c,product:{name:n,text:q,code:o,code_system:p,translation:{name:r,code:s,code_system:t,code_system_name:u}},dose_quantity:{value:v,unit:w},rate_quantity:{value:x,unit:y},precondition:{name:z,code:A,code_system:B},reason:{name:C,code:D,code_system:E},route:{name:F,code:G,code_system:H,code_system_name:I},schedule:{type:j,period_value:k,period_unit:l},vehicle:{name:J,code:K,code_system:L,code_system_name:M},administration:{name:N,code:O,code_system:P,code_system_name:Q},prescriber:{organization:R,person:S}})}),g},d.C32.problems=function(c){var d,e=b.parseDate,f=(b.parseName,b.parseAddress,c.section("problems")),g={};return g.entries=[],g.displayName="Problems",g.templateId="",g.text=f.tag("text").val(),f.entries().each(function(b){d=b.tag("effectiveTime");var c=e(d.tag("low").attr("value")),f=e(d.tag("high").attr("value"));d=b.template("2.16.840.1.113883.10.20.1.28").tag("value");var h=d.attr("displayName"),i=d.attr("code"),j=d.attr("codeSystem"),k=d.attr("codeSystemName");h||(d=b.template("2.16.840.1.113883.10.20.1.28").tag("originalText"),d.isEmpty()||(h=a.stripWhitespace(d.val()))),d=b.template("2.16.840.1.113883.10.20.1.28").tag("translation");var l=d.attr("displayName"),m=d.attr("code"),n=d.attr("codeSystem"),o=d.attr("codeSystemName");d=b.template("2.16.840.1.113883.10.20.1.50");var p=d.tag("value").attr("displayName"),q=null;d=b.template("2.16.840.1.113883.10.20.1.38"),d.isEmpty()||(q=parseFloat(d.tag("value").attr("value"))),g.entries.push({date_range:{start:c,end:f},name:h,status:p,age:q,code:i,code_system:j,code_system_name:k,translation:{name:l,code:m,code_system:n,code_system_name:o},comment:null})}),g},d.C32.procedures=function(c){var d,e=b.parseDate,f=(b.parseName,b.parseAddress),g=c.section("procedures"),h={};return h.entries=[],h.displayName="Procedures",h.templateId="",h.text=g.tag("text").val(),g.entries().each(function(b){d=b.tag("effectiveTime");var c=e(d.attr("value"));d=b.tag("code");var g=d.attr("displayName"),i=d.attr("code"),j=d.attr("codeSystem");g||(g=a.stripWhitespace(b.tag("originalText").val())),d=b.tag("specimen").tag("code");var k=d.attr("displayName"),l=d.attr("code"),m=d.attr("codeSystem");d=b.tag("performer").tag("addr");var n=d.tag("name").val(),o=d.tag("telecom").attr("value"),p=f(d);p.organization=n,p.phone=o,d=b.tag("participant").tag("code");var q=d.attr("displayName"),r=d.attr("code"),s=d.attr("codeSystem");h.entries.push({date:c,name:g,code:i,code_system:j,specimen:{name:k,code:l,code_system:m},performer:p,device:{name:q,code:r,code_system:s}})}),h},d.C32.vitals=function(a){var c,d=b.parseDate,e=(b.parseName,b.parseAddress,a.section("vitals")),f={};return f.entries=[],f.displayName="Vitals",f.templateId="",f.text=e.tag("text").val(),e.entries().each(function(a){c=a.tag("effectiveTime");for(var b,e=d(c.attr("value")),g=a.elsByTag("component"),h=[],i=0;i<g.length;i++){b=g[i],c=b.tag("code");var j=c.attr("displayName"),k=c.attr("code"),l=c.attr("codeSystem"),m=c.attr("codeSystemName");c=b.tag("value");var n=parseFloat(c.attr("value")),o=c.attr("unit");h.push({name:j,code:k,code_system:l,code_system_name:m,value:n,unit:o})}f.entries.push({date:e,results:h})}),f},d.CCDA=function(){var b=function(b){var c={};return c.document=d.CCDA.document(b),c.allergies=d.CCDA.allergies(b),c.care_plan=d.CCDA.care_plan(b),c.chief_complaint=d.CCDA.free_text(b,"chief_complaint"),c.demographics=d.CCDA.demographics(b),c.encounters=d.CCDA.encounters(b),c.functional_statuses=d.CCDA.functional_statuses(b),c.immunizations=d.CCDA.immunizations(b).administered,c.immunization_declines=d.CCDA.immunizations(b).declined,c.instructions=d.CCDA.instructions(b),c.results=d.CCDA.results(b),c.medications=d.CCDA.medications(b),c.problems=d.CCDA.problems(b),c.procedures=d.CCDA.procedures(b),c.smoking_status=d.CCDA.smoking_status(b),c.vitals=d.CCDA.vitals(b),c.json=a.json,c.document.json=a.json,c.allergies.json=a.json,c.care_plan.json=a.json,c.chief_complaint.json=a.json,c.demographics.json=a.json,c.encounters.json=a.json,c.functional_statuses.json=a.json,c.immunizations.json=a.json,c.immunization_declines.json=a.json,c.instructions.json=a.json,c.results.json=a.json,c.medications.json=a.json,c.problems.json=a.json,c.procedures.json=a.json,c.smoking_status.json=a.json,c.vitals.json=a.json,c};return{run:b}}(),d.CCDA.document=function(c){var d,e,f=b.parseDate,g=b.parseName,h=b.parseAddress,i={},j=c.section("document"),k=j.elsByTag("templateId"),l=k[0].attr("root");e=k.length>1?k[1].attr("root"):l;var m=j.tag("code").attr("code"),n=(j.tag("templateId").attr("root"),j.tag("code").attr("displayName")),o=j.tag("nonXMLBody"),p=o.el.childNodes,q="structured",r={type:"",mediaType:"",representation:"",rawText:"",reference:""};if(p&&p.length>0){q="unstructured";var s=o.tag("text"),t="",u="",v="",w="",x="";s&&s.attr("mediaType")&&(t=s.attr("mediaType"),u=s.attr("representation"),v=s.val(),x="embedded"),s&&!t&&(w=s.tag("reference").attr("value"),x="reference"),r={type:x,mediaType:t,representation:u,rawText:v,reference:w}}var y={type:"CCDAR2",rootTemplateId:l,templateId:e,displayName:n,loinc:m,bodyType:q,nonXmlBody:r};console.log("DOCTYPE"),console.log(y);var z=f(j.tag("effectiveTime").attr("value")),A=a.stripWhitespace(j.tag("title").val()),B=j.tag("author");d=B.tag("assignedPerson").tag("name");var C=g(d);d=B.tag("addr");var D=h(d);d=B.tag("telecom");for(var E=d.attr("value"),F=[],G=j.tag("documentationOf").elsByTag("performer"),H=0;H<G.length;H++){d=G[H];var I=g(d),J=d.tag("telecom").attr("value"),K=h(d.tag("addr"));F.push({name:I,phone:{work:J},address:K})}d=j.tag("encompassingEncounter").tag("location");var L=a.stripWhitespace(d.tag("name").val()),M=h(d.tag("addr")),N=null;return d=d.tag("effectiveTime"),d.isEmpty()||(N=f(d.attr("value"))),i={type:y,date:z,title:A,author:{name:C,address:D,phone:{work:E}},documentation_of:F,location:{name:L,address:M,encounter_date:N}}},d.CCDA.allergies=function(c){var d,e=b.parseDate,f=(b.parseName,b.parseAddress,c.section("allergies")),g={};return g.entries=[],g.displayName="Allergies",g.templateId="",g.text=f.tag("text").val(),f.entries().each(function(b){d=b.tag("effectiveTime");var c=e(d.tag("low").attr("value")),f=e(d.tag("high").attr("value"));d=b.template("2.16.840.1.113883.10.20.22.4.7").tag("code");var h=d.attr("displayName"),i=d.attr("code"),j=d.attr("codeSystem"),k=d.attr("codeSystemName");d=b.template("2.16.840.1.113883.10.20.22.4.7").tag("value");var l=d.attr("displayName"),m=d.attr("code"),n=d.attr("codeSystem"),o=d.attr("codeSystemName");d=b.template("2.16.840.1.113883.10.20.22.4.9").tag("value");var p=d.attr("displayName"),q=d.attr("code"),r=d.attr("codeSystem");d=b.template("2.16.840.1.113883.10.20.22.4.8").tag("value");var s=d.attr("displayName");d=b.tag("participant").tag("code");var t=d.attr("displayName"),u=d.attr("code"),v=d.attr("codeSystem"),w=d.attr("codeSystemName");t||(d=b.tag("participant").tag("name"),d.isEmpty()||(t=d.val())),t||(d=b.template("2.16.840.1.113883.10.20.22.4.7").tag("originalText"),d.isEmpty()||(t=a.stripWhitespace(d.val()))),d=b.template("2.16.840.1.113883.10.20.22.4.28").tag("value");var x=d.attr("displayName");g.entries.push({date_range:{start:c,end:f},name:h,code:i,code_system:j,code_system_name:k,status:x,severity:s,reaction:{name:p,code:q,code_system:r},reaction_type:{name:l,code:m,code_system:n,code_system_name:o},allergen:{name:t,code:u,code_system:v,code_system_name:w}})}),g},d.CCDA.care_plan=function(b){var c,d=[],e=b.section("care_plan");return e.entries().each(function(b){var e=null,f=null,g=null,h=null;c=b.template("2.16.840.1.113883.10.20.22.4.40"),c.isEmpty()?(c=b.tag("code"),e=c.attr("displayName"),f=c.attr("code"),g=c.attr("codeSystem"),h=c.attr("codeSystemName")):e="encounter";var i=a.stripWhitespace(b.tag("text").val());d.push({text:i,name:e,code:f,code_system:g,code_system_name:h})}),d},d.CCDA.demographics=function(c){var d,e=b.parseDate,f=b.parseName,g=b.parseAddress,h={},i=c.section("demographics"),j=i.tag("patientRole");d=j.tag("patient").tag("name");var k=f(d);d=j.tag("patient");var l=e(d.tag("birthTime").attr("value")),m=a.Codes.gender(d.tag("administrativeGenderCode").attr("code")),n=a.Codes.maritalStatus(d.tag("maritalStatusCode").attr("code"));d=j.tag("addr");var o=g(d);d=j.tag("telecom");var p=d.attr("value"),q=null,r=null,s=null,t=j.tag("languageCommunication").tag("languageCode").attr("code"),u=j.tag("raceCode").attr("displayName"),v=j.tag("ethnicGroupCode").attr("displayName"),w=j.tag("religiousAffiliationCode").attr("displayName");d=j.tag("birthplace");var x=g(d);d=j.tag("guardian");var y=d.tag("code").attr("displayName"),z=d.tag("code").attr("code"),A=d.tag("telecom").attr("value");d=d.tag("guardianPerson").tag("name");var B=f(d);d=j.tag("guardian").tag("addr");var C=g(d);d=j.tag("providerOrganization");var D=d.tag("name").val(),E=d.tag("telecom").attr("value"),F=g(d.tag("addr"));return h={name:k,dob:l,gender:m,marital_status:n,address:o,phone:{home:p,work:q,mobile:r},email:s,language:t,race:u,ethnicity:v,religion:w,birthplace:{state:x.state,zip:x.zip,country:x.country},guardian:{name:{given:B.given,family:B.family},relationship:y,relationship_code:z,address:C,phone:{home:A}},provider:{organization:D,phone:E,address:F}}},d.CCDA.encounters=function(a){var c,d=b.parseDate,e=(b.parseName,b.parseAddress),f=a.section("encounters"),g={};return g.entries=[],g.displayName="Encounters",g.templateId="",g.text=f.tag("text").val(),f.entries().each(function(a){var b=d(a.tag("effectiveTime").attr("value"));c=a.tag("code");var f=c.attr("displayName"),h=c.attr("code"),i=c.attr("codeSystem"),j=c.attr("codeSystemName"),k=c.attr("codeSystemVersion");c=a.tag("translation");var l=c.attr("displayName"),m=c.attr("code"),n=c.attr("codeSystem"),o=c.attr("codeSystemName");c=a.tag("performer").tag("code");var p=c.attr("displayName"),q=c.attr("code"),r=c.attr("codeSystem"),s=c.attr("codeSystemName");c=a.tag("participant");var t=c.tag("code").attr("displayName"),u=e(c);u.organization=t;for(var v=[],w=a.elsByTag("entryRelationship"),x=0;x<w.length;x++)c=w[x].tag("value"),v.push({name:c.attr("displayName"),code:c.attr("code"),code_system:c.attr("codeSystem")});g.entries.push({date:b,name:f,code:h,code_system:i,code_system_name:j,code_system_version:k,findings:v,translation:{name:l,code:m,code_system:n,code_system_name:o},performer:{name:p,code:q,code_system:r,code_system_name:s},location:u})}),g},d.CCDA.free_text=function(b,c){var d={},e=b.section(c),f=a.stripWhitespace(e.tag("text").val());return d={text:f}},d.CCDA.functional_statuses=function(a){var c,d=b.parseDate,e=[],f=a.section("functional_statuses");return f.entries().each(function(a){var b=d(a.tag("effectiveTime").attr("value"));b||(b=d(a.tag("effectiveTime").tag("low").attr("value"))),c=a.tag("value");var f=c.attr("displayName"),g=c.attr("code"),h=c.attr("codeSystem"),i=c.attr("codeSystemName");e.push({date:b,name:f,code:g,code_system:h,code_system_name:i})}),e},d.CCDA.immunizations=function(c){var d,e,f=b.parseDate,g=(b.parseName,b.parseAddress,{}),h={},i=c.section("immunizations");return g.entries=[],g.displayName="Immunizations",g.templateId="",g.text=i.tag("text").val(),h.entries=[],h.displayName="Immunizations Declined",h.templateId="",h.text=i.tag("text").val(),i.entries().each(function(b){e=b.tag("effectiveTime");var c=f(e.attr("value"));c||(c=f(e.tag("low").attr("value"))),e=b.tag("substanceAdministration");var i=e.boolAttr("negationInd");d=b.template("2.16.840.1.113883.10.20.22.4.54"),e=d.tag("code");var j=e.attr("displayName"),k=e.attr("code"),l=e.attr("codeSystem"),m=e.attr("codeSystemName");e=d.tag("translation");var n=e.attr("displayName"),o=e.attr("code"),p=e.attr("codeSystem"),q=e.attr("codeSystemName");e=d.tag("lotNumberText");var r=e.val();e=d.tag("manufacturerOrganization");var s=e.tag("name").val();e=b.tag("routeCode");var t=e.attr("displayName"),u=e.attr("code"),v=e.attr("codeSystem"),w=e.attr("codeSystemName");e=b.template("2.16.840.1.113883.10.20.22.4.20");var x=a.stripWhitespace(e.tag("text").val());e=e.tag("code");var y=e.attr("displayName"),z=e.attr("code"),A=e.attr("codeSystem");e=b.tag("doseQuantity");var B=e.attr("value"),C=e.attr("unit"),D=i?h:g;D.entries.push({date:c,product:{name:j,code:k,code_system:l,code_system_name:m,translation:{name:n,code:o,code_system:p,code_system_name:q},lot_number:r,manufacturer_name:s},dose_quantity:{value:B,unit:C},route:{name:t,code:u,code_system:v,code_system_name:w},instructions:x,education_type:{name:y,code:z,code_system:A}})}),{administered:g,declined:h}},d.CCDA.instructions=function(b){var c,d=[],e=b.section("instructions");return e.entries().each(function(b){c=b.tag("code");var e=c.attr("displayName"),f=c.attr("code"),g=c.attr("codeSystem"),h=c.attr("codeSystemName"),i=a.stripWhitespace(b.tag("text").val());d.push({text:i,name:e,code:f,code_system:g,code_system_name:h})}),d},d.CCDA.results=function(c){var d,e=b.parseDate,f=(b.parseName,b.parseAddress,c.section("results")),g={};return g.entries=[],g.displayName="Results",g.templateId="",g.text=f.tag("text").val(),f.entries().each(function(b){d=b.tag("code");for(var c,f=d.attr("displayName"),h=d.attr("code"),i=d.attr("codeSystem"),j=d.attr("codeSystemName"),k=b.elsByTag("observation"),l=[],m=0;m<k.length;m++){c=k[m];var n=e(c.tag("effectiveTime").attr("value"));d=c.tag("code");var o=d.attr("displayName"),p=d.attr("code"),q=d.attr("codeSystem"),r=d.attr("codeSystemName");o||(o=a.stripWhitespace(c.tag("text").val())),d=c.tag("translation");var s=d.attr("displayName"),t=d.attr("code"),u=d.attr("codeSystem"),v=d.attr("codeSystemName");d=c.tag("value");var w=d.attr("value"),x=d.attr("unit");w&&!isNaN(parseFloat(w))&&(w=parseFloat(w)),w||(w=d.val()),d=c.tag("referenceRange");var y=a.stripWhitespace(d.tag("observationRange").tag("text").val()),z=d.tag("observationRange").tag("low").attr("unit"),A=d.tag("observationRange").tag("low").attr("value"),B=d.tag("observationRange").tag("high").attr("unit"),C=d.tag("observationRange").tag("high").attr("value");l.push({date:n,name:o,value:w,unit:x,code:p,code_system:q,code_system_name:r,translation:{name:s,code:t,code_system:u,code_system_name:v},reference_range:{text:y,low_unit:z,low_value:A,high_unit:B,high_value:C}})}g.entries.push({name:f,code:h,code_system:i,code_system_name:j,tests:l})}),g},d.CCDA.medications=function(c){var d,e=b.parseDate,f=c.section("medications"),g={};return g.entries=[],g.displayName="Medications",g.templateId="",g.text=f.tag("text").val(),f.entries().each(function(b){d=b.tag("text");var c=a.stripWhitespace(d.val()),f=b.elsByTag("effectiveTime");d=f[0];var h=null,i=null;d&&(h=e(d.tag("low").attr("value")),i=e(d.tag("high").attr("value"))),d=f[1];var j=null,k=null,l=null;if(d&&"PIVL_TS"===d.attr("xsi:type")){var m=d.attr("institutionSpecified");"true"===m?j="frequency":"false"===m&&(j="interval"),d=d.tag("period"),k=d.attr("value"),l=d.attr("unit")}d=b.tag("manufacturedProduct").tag("code");var n=d.attr("displayName"),o=d.attr("code"),p=d.attr("codeSystem"),q=null;d=b.tag("manufacturedProduct").tag("originalText"),d.isEmpty()||(q=a.stripWhitespace(d.val())),!n&&q&&(n=q),d=b.tag("manufacturedProduct").tag("translation");var r=d.attr("displayName"),s=d.attr("code"),t=d.attr("codeSystem"),u=d.attr("codeSystemName");d=b.tag("doseQuantity");var v=d.attr("value"),w=d.attr("unit");d=b.tag("rateQuantity");var x=d.attr("value"),y=d.attr("unit");d=b.tag("precondition").tag("value");var z=d.attr("displayName"),A=d.attr("code"),B=d.attr("codeSystem");d=b.template("2.16.840.1.113883.10.20.22.4.19").tag("value");var C=d.attr("displayName"),D=d.attr("code"),E=d.attr("codeSystem");d=b.tag("routeCode");var F=d.attr("displayName"),G=d.attr("code"),H=d.attr("codeSystem"),I=d.attr("codeSystemName");d=b.tag("participant").tag("playingEntity");var J=d.tag("name").val();d=d.tag("code"),J=d.attr("displayName")||J;var K=d.attr("code"),L=d.attr("codeSystem"),M=d.attr("codeSystemName");d=b.tag("administrationUnitCode");var N=d.attr("displayName"),O=d.attr("code"),P=d.attr("codeSystem"),Q=d.attr("codeSystemName");d=b.tag("performer");var R=d.tag("name").val(),S=null;g.entries.push({date_range:{start:h,end:i},text:c,product:{name:n,code:o,code_system:p,text:q,translation:{name:r,code:s,code_system:t,code_system_name:u}},dose_quantity:{value:v,unit:w},rate_quantity:{value:x,unit:y},precondition:{name:z,code:A,code_system:B},reason:{name:C,code:D,code_system:E},route:{name:F,code:G,code_system:H,code_system_name:I},schedule:{type:j,period_value:k,period_unit:l},vehicle:{name:J,code:K,code_system:L,code_system_name:M},administration:{name:N,code:O,code_system:P,code_system_name:Q},prescriber:{organization:R,person:S}})}),g},d.CCDA.problems=function(c){var d,e=b.parseDate,f=(b.parseName,b.parseAddress,c.section("problems")),g={};return g.entries=[],g.displayName="Problems",g.templateId="",g.text=f.tag("text").val(),f.entries().each(function(b){d=b.tag("effectiveTime");var c=e(d.tag("low").attr("value")),f=e(d.tag("high").attr("value"));d=b.template("2.16.840.1.113883.10.20.22.4.4").tag("value");var h=d.attr("displayName"),i=d.attr("code"),j=d.attr("codeSystem"),k=d.attr("codeSystemName");d=b.template("2.16.840.1.113883.10.20.22.4.4").tag("translation");var l=d.attr("displayName"),m=d.attr("code"),n=d.attr("codeSystem"),o=d.attr("codeSystemName");d=b.template("2.16.840.1.113883.10.20.22.4.6");var p=d.tag("value").attr("displayName"),q=null;d=b.template("2.16.840.1.113883.10.20.22.4.31"),d.isEmpty()||(q=parseFloat(d.tag("value").attr("value"))),d=b.template("2.16.840.1.113883.10.20.22.4.64");var r=a.stripWhitespace(d.tag("text").val());g.entries.push({date_range:{start:c,end:f},name:h,status:p,age:q,code:i,code_system:j,code_system_name:k,translation:{name:l,code:m,code_system:n,code_system_name:o},comment:r})}),g},d.CCDA.procedures=function(c){var d,e=b.parseDate,f=(b.parseName,b.parseAddress),g=c.section("procedures"),h={};return h.entries=[],h.displayName="Procedures",h.templateId="",h.text=g.tag("text").val(),g.entries().each(function(b){d=b.tag("effectiveTime");var c=e(d.attr("value"));d=b.tag("code");var g=d.attr("displayName"),i=d.attr("code"),j=d.attr("codeSystem");g||(g=a.stripWhitespace(b.tag("originalText").val())),d=b.tag("specimen").tag("code");var k=d.attr("displayName"),l=d.attr("code"),m=d.attr("codeSystem");d=b.tag("performer").tag("addr");var n=d.tag("name").val(),o=d.tag("telecom").attr("value"),p=f(d);p.organization=n,p.phone=o,d=b.template("2.16.840.1.113883.10.20.22.4.37").tag("code");var q=d.attr("displayName"),r=d.attr("code"),s=d.attr("codeSystem");h.entries.push({date:c,name:g,code:i,code_system:j,specimen:{name:k,code:l,code_system:m},performer:p,device:{name:q,code:r,code_system:s}})}),h},d.CCDA.smoking_status=function(a){for(var c,d,e=b.parseDate,f=(b.parseName,b.parseAddress,null),g=null,h=null,i=null,j=null,k=a.section("social_history"),l=k.entries(),m=0;m<l.length;m++){var n=l[m],o=n.template("2.16.840.1.113883.10.20.22.4.78");if(o.isEmpty()&&(o=n.template("2.16.840.1.113883.10.22.4.78")),!o.isEmpty()&&(d=o.tag("effectiveTime"),j=e(d.attr("value")),d=o.tag("value"),f=d.attr("displayName"),g=d.attr("code"),h=d.attr("codeSystem"),i=d.attr("codeSystemName"),f))break}return c={date:j,name:f,code:g,code_system:h,code_system_name:i}},d.CCDA.vitals=function(a){var c,d=b.parseDate,e=(b.parseName,b.parseAddress,a.section("vitals")),f={};return f.entries=[],f.displayName="Vitals",f.templateId="",f.text=e.tag("text").val(),e.entries().each(function(a){c=a.tag("effectiveTime");for(var b,e=d(c.attr("value")),g=a.elsByTag("component"),h=[],i=0;i<g.length;i++){b=g[i],c=b.tag("code");var j=c.attr("displayName"),k=c.attr("code"),l=c.attr("codeSystem"),m=c.attr("codeSystemName");c=b.tag("value");var n=parseFloat(c.attr("value")),o=c.attr("unit");h.push({name:j,code:k,code_system:l,code_system_name:m,value:n,unit:o})}f.entries.push({date:e,results:h})}),f},d.GenericInfo=function(a,b){var c=function(a){for(var b=0;b<this.length;b++)a(this[b])},d=a.elsByTag("section");d.each=c,d.each(function(a){var c=a.tag("code").attr("displayName");if(c){var d=c.split(" ").join("_").toLowerCase();b[d]||(b[d]={}),b[d].displayName=c,b[d].templateId=a.tag("templateId").attr("root"),b[d].text=a.tag("text").val(!0)}})},d.CCDAR2=function(){var b=function(b){var c={};return c.document=d.CCDAR2.document(b),c.demographics=d.CCDA.demographics(b),c.health_concerns_document=d.CCDAR2.health_concerns_document(b),c.json=a.json,d.GenericInfo(b,c),c};return{run:b}}(),d.CCDAR2.document=function(c){var d,e,f=b.parseDate,g=b.parseName,h=b.parseAddress,i={},j=c.section("document"),k=f(j.tag("effectiveTime").attr("value")),l=a.stripWhitespace(j.tag("title").val()),m=j.elsByTag("templateId"),n=m[0].attr("root");e=m.length>1?m[1].attr("root"):n;var o=j.tag("code").attr("code"),p=(j.tag("templateId").attr("root"),j.tag("code").attr("displayName")),q=j.tag("nonXMLBody"),r=q.el.childNodes,s="structured",t={type:"",mediaType:"",representation:"",rawText:"",reference:""};if(r&&r.length>0){s="unstructured";var u=q.tag("text"),v="",w="",x="",y="",z="";u&&u.attr("mediaType")&&(v=u.attr("mediaType"),w=u.attr("representation"),x=u.val(),z="embedded"),u&&!v&&(y=u.tag("reference").attr("value"),z="reference"),t={type:z,mediaType:v,representation:w,rawText:x,reference:y}}var A={type:"CCDAR2",rootTemplateId:n,templateId:e,displayName:p,loinc:o,bodyType:s,nonXmlBody:t};console.log("DOCTYPE"),console.log(A);var B=j.tag("author");d=B.tag("assignedPerson").tag("name");var C=g(d);d=B.tag("addr");var D=h(d);d=B.tag("telecom");for(var E=d.attr("value"),F=[],G=j.tag("documentationOf").elsByTag("performer"),H=0;H<G.length;H++){d=G[H];var I=g(d),J=d.tag("telecom").attr("value"),K=h(d.tag("addr"));F.push({name:I,phone:{work:J},address:K})}d=j.tag("encompassingEncounter").tag("location");var L=a.stripWhitespace(d.tag("name").val()),M=h(d.tag("addr")),N=null;return d=d.tag("effectiveTime"),d.isEmpty()||(N=f(d.attr("value"))),i={type:A,date:k,title:l,author:{name:C,address:D,phone:{work:E}},documentation_of:F,location:{name:L,address:M,encounter_date:N}}},d.CCDAR2.health_concerns_document=function(a){var c=b.parseDate,d=(b.parseName,b.parseAddress,function(a){for(var b=0;b<this.length;b++)a(this[b])}),e={};e.entries=[],e.text=a.tag("text").val();var f=a.section("health_concerns_document");f.tag("title").val();return f.entries().each(function(a){var b={},f=a.tag("act"),g=(f.elsByTag("entryRelationship"),f.tag("templateId").attr("root"),f.tag("id").attr("root"),f.tag("statusCode").attr("code"),f.tag("code")),h=g.attr("displayName"),i=c(a.tag("effectiveTime")),j={effective_time:i,name:h,entry_relationship:[]},k=a.elsByTag("entryRelationship");k.each=d,k.each(function(a){var b={type_code:a.attr("typeCode"),observations:[]},c=a.elsByTag("observation");c.each=d,c.each(function(a){b.observations.push({class_code:a.attr("classCode"),mood_code:a.attr("moodCode"),display_name:a.tag("value").attr("displayName"),status:a.tag("statusCode").attr("code")})}),j.entry_relationship.push(b)}),b.act=j,e.entries.push(b)}),e};var e=(function(){var a=function(){};return{method:a}}(),function(e,f){var g,h,i;if(f||(f={}),h=a.parseData(e),f.parser)i=f.parser();else switch(g=b.detect(h)){case"c32":h=b.C32.process(h),i=d.C32.run(h);break;case"ccda":h=b.CCDA.process(h),i=d.CCDA.run(h);break;case"ccdar2":h=b.CCDAR2.process(h),i=d.CCDAR2.run(h);break;case"json":switch(f.generatorType){case"c32":g="c32",i=c.C32.run(h,f.template,f.testingMode);break;case"ccda":g="ccda",i=c.CCDA.run(h,f.template,f.testingMode)}}return{type:g,data:i,source:h}});return e});